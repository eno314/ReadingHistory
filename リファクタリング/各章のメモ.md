# リファクタリング 各章のメモ

## 装丁読み

- リファクタリング
- 既存のコードを安全に改善する
- 第2版
- Refactoring
- Improving the Design of Existing Code
- Second Edition
- 著
  - [Martin Fowler](https://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%83%BB%E3%83%95%E3%82%A1%E3%82%A6%E3%83%A9%E3%83%BC)
  - with contributions by [Kent Beck](https://ja.wikipedia.org/wiki/%E3%82%B1%E3%83%B3%E3%83%88%E3%83%BB%E3%83%99%E3%83%83%E3%82%AF)

## 本書に寄せて

小さなステップでコードを変更していくコツは自分も知りたいし身につけたいなと思った。リファクタリングする際につい大きく変えてしまいがちなので。

## はじめに

- リファクタリングとは
  - 外部の振る舞いを保ったままで内部の構造を改善していく作業
  - 実装した後で設計すること
- 本書の内容
  - 1章
    - リファクタリングの例（悪い設計のプログラムを実際にリファクタリングする）
    - リファクタリングが何かを知るための章
  - 2章
    - リファクタリング理論（原則や定義、理由）
    - なぜリファクタリングすべきかを知るための章
  - 3章
    - 「鼻につく」コードの嗅ぎ分けかたと、それをリファクタリングする方法
    - どこをリファクタリングすべきかを知るための章
  - 4章
    - コードにテストを組み入れていく方法
  - 5章以降
    - リファクタリングのカタログ
    - 参照用
    - まずはどこに何が書かれているのかをざっと目を通すだけで良い
- 本書はさまざまなリファクタリングに名前を付けている語彙集にもなっている
  - 今後、この語彙を使って会話するようにしたい

## 1章

- リファクタリングは変更のときにやる。コードが正常に動いていて、変更の予定が無いのであれば、放置しておいても構わない。
  - これはその通りだと思う。たまに昔書いたイケていないコード直したい衝動に駆られるけど、変更する予定が無いなら気にせずいたほうが良い。その代わり変更する際にちゃんとリファクタリングする。っていうのを実践したい。
- 返り値を常にresultという変数名にするのは、関数名がしっかりとしていればいい案だなと思う。
- 特定の役割を持つことを名前で伝えたい場合でなければ、不定冠詞を先頭につけるっていうのも初めて聞いたけど、なるほどなと思った。
- 変数のインライン化はやりすぎかなと思ったけど、関数の抽出を考えるとここまでやったほうが良いのかとも感じた。
- リファクタリングする際はコンパイル・テスト・コミットを細かくやる。自身が無いときほどこの流れを細かくやることを意識しよう。
- リファクタリングする前に安心できるまでテストを追加するのはやっぱり必要だよなと改めて思った。このコードをテスト無しにリファクタリングするのは不安に思えるくらいに自動テストに慣れてきている気がする。
- ちゃんと写経していったら、最後の方で小さく修正するのが自然と出来てきた。これを仕事でも続けるようにしたい。
- 筆者が思う良いコード : 小さく、適切に名付けられた関数 -> 変更が容易
  - これには同意だけど、上手に分けないとどこに何があるのか分かりにくいこともあるんだよね。。この本を読むことで上手に小さく適切に名付けられた関数を作れるようになれるといいな。

## 2章

- リファクタリングの目的
  - 開発スピードをあげる
  - 理解や修正が容易になるようする
- リファクタリングはコードが壊れた状態になる期間を短くする。規模が大きいリファクタリングも少しずつ変更し、リリースしていく
- リファクタリングの途中でバグに気づいても、一旦そのままにしてリファクタリングが終わった後でバグを直す
- コードを修正する前に既存のコードを読んで、その際に理解しにくいところがあるなら、それはリファクタリングのサイン
- 変更する前に、その変更が容易になるようにリファクタリングし、その後で変更を行う。
- パフォーマンスチューニングの方法（参考にしたい）
  1. まずはパフォーマンスを考えずに、変更しやすい・理解しやすいコードを書く
  2. プロファイラを使って、どこがボトルネックになっているかを調べる（計測しない推測は大体外れるからやらない）
  3. ボトルネックになっている部分がわかったら、通常のリファクタリングと同様に小さく、少しずつ修正する

## 第3章

- メトリックスよりも経験はそうだなと思う。その時々で長過ぎと思う場合もあれば、多少長くても構わないと思う場合もある。とはいえメトリックスも全く当てにならないわけじゃないし、計測できるものは計測するのが良いかなと思う。
- 意識したい
  - 良い名前が思いつかない場合は、設計がまだ固まっていないサインだから、そんなときこそ、より頭をひねる
  - 1つの変更のために、いろんなところを修正する必要があるのは、リファクタリングのサイン
  - 数個のデータがつるんで複数箇所に出てくるのは、まとめるサイン
  - 将来のためを思って作ったり、そのときは必要だった構造化（小さなクラスや関数化）が、今はもう不要になってしまったのであれば消す（インライン化する）
  - 無闇矢鱈にデータクラスを作らない、振る舞いを持たせられないかを検討する
  - コメントが必要だということは、理解しにくいコードのサイン。

### 第4章

- 今、仕事で手動でやっているテストを全部、自動でできないかを検討しないといけないなと感じた。もっとユニットテスト以外も自動テストの意識を高める必要があるなと感じた。
- 自分もユニットテストをすぐ書く（できればTDDで開発する）という意識になってから、デバッグする時間は減ったという感覚がある。これがユニットテスト（TDD）の一番のメリットかもしれない。
- テストが失敗するかの確認はたしかに不安になることがあるからやりたくなるのはわかる。TDDならその確認できるんだけど、テストコードがないところに追加する場合は、たしかにやるようにしたほうが良いかも知れない。
- この章の写経をしてみて、JavaScriptみたいな動的型付け言語はどこまでテストを書けば良いのかの判断が難しいなと思った。慣れるまではペアプロやチームで相談しながらテストをどこまで書くか決めるのが良いな

### 5章以降

- サンプルコードもできるだけ写経したいな
- 関数は長さや再利用よりも意図を意識して作る。「How」ではなく「What」で名前を付ける。これらは他の本でも良くある内容だけど、これを読んでもっともっと意識したいなと思った。
